---
description: 테스트 작성 가이드 - 백엔드/프론트엔드 테스트 전략
---
# 테스트 작성 가이드

## 백엔드 테스트 (Python/Pytest)

### 테스트 구조
```
backend/
├── tests/
│   ├── __init__.py
│   ├── conftest.py          # Fixtures
│   ├── test_auth.py         # 인증 테스트
│   ├── test_policies.py     # 약관 관리 테스트
│   ├── test_search.py       # 검색 테스트
│   └── test_agents.py       # 에이전트 테스트
```

### Pytest 설정
```python
# conftest.py
import pytest
from httpx import AsyncClient
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession

@pytest.fixture
async def client():
    """테스트용 HTTP 클라이언트"""
    async with AsyncClient(app=app, base_url="http://test") as ac:
        yield ac

@pytest.fixture
async def db_session():
    """테스트용 데이터베이스 세션"""
    engine = create_async_engine("sqlite+aiosqlite:///:memory:")
    async with AsyncSession(engine) as session:
        yield session
```

### API 테스트 예시
```python
# test_auth.py
import pytest
from httpx import AsyncClient

@pytest.mark.asyncio
async def test_login_success(client: AsyncClient):
    """로그인 성공 테스트"""
    response = await client.post(
        "/auth/login",
        json={"email": "test@example.com", "password": "password123"}
    )
    
    assert response.status_code == 200
    data = response.json()
    assert "access_token" in data
    assert data["token_type"] == "bearer"

@pytest.mark.asyncio
async def test_login_invalid_credentials(client: AsyncClient):
    """잘못된 인증 정보로 로그인 시도"""
    response = await client.post(
        "/auth/login",
        json={"email": "test@example.com", "password": "wrong"}
    )
    
    assert response.status_code == 401
    assert "detail" in response.json()
```

### 서비스 레이어 테스트
```python
# test_chunking_service.py
import pytest
from services.chunking_service import ChunkingService

@pytest.mark.asyncio
async def test_chunk_text():
    """텍스트 청킹 테스트"""
    service = ChunkingService()
    text = "긴 텍스트..." * 100
    
    chunks = await service.chunk_text(text, chunk_size=500)
    
    assert len(chunks) > 0
    assert all(len(chunk) <= 500 for chunk in chunks)
    # 오버랩 확인
    assert chunks[0][-50:] in chunks[1]
```

### 에이전트 테스트
```python
# test_agents.py
import pytest
from agents.embedding_agent import EmbeddingAgent

@pytest.mark.asyncio
async def test_embedding_generation():
    """임베딩 생성 테스트"""
    agent = EmbeddingAgent()
    text = "보험약관 테스트 텍스트"
    
    embedding = await agent.generate_embedding(text)
    
    assert len(embedding) == 1536  # OpenAI 임베딩 차원
    assert all(isinstance(x, float) for x in embedding)
```

### Mock 사용
```python
from unittest.mock import AsyncMock, patch

@pytest.mark.asyncio
async def test_search_with_mock():
    """외부 API 호출을 Mock으로 대체"""
    
    with patch('services.openai_service.create_embedding') as mock:
        mock.return_value = [0.1] * 1536
        
        result = await search_service.search("test query")
        
        mock.assert_called_once()
        assert result is not None
```

### 테스트 실행
```bash
# 모든 테스트 실행
pytest

# 특정 파일 테스트
pytest tests/test_auth.py

# 특정 테스트 함수
pytest tests/test_auth.py::test_login_success

# 커버리지 확인
pytest --cov=backend --cov-report=html
```

## 프론트엔드 테스트 (Jest/React Testing Library)

### 테스트 구조
```
frontend/
├── __tests__/
│   ├── components/
│   │   ├── Button.test.tsx
│   │   └── ChatInterface.test.tsx
│   ├── hooks/
│   │   └── useAuth.test.ts
│   └── services/
│       └── api.test.ts
```

### 컴포넌트 테스트
```typescript
// __tests__/components/Button.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { Button } from '@/components/Button';

describe('Button 컴포넌트', () => {
  it('버튼이 렌더링된다', () => {
    render(<Button>클릭</Button>);
    expect(screen.getByText('클릭')).toBeInTheDocument();
  });

  it('클릭 이벤트가 작동한다', () => {
    const handleClick = jest.fn();
    render(<Button onClick={handleClick}>클릭</Button>);
    
    fireEvent.click(screen.getByText('클릭'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it('disabled 상태일 때 클릭되지 않는다', () => {
    const handleClick = jest.fn();
    render(<Button onClick={handleClick} disabled>클릭</Button>);
    
    fireEvent.click(screen.getByText('클릭'));
    expect(handleClick).not.toHaveBeenCalled();
  });
});
```

### 훅 테스트
```typescript
// __tests__/hooks/useAuth.test.ts
import { renderHook, act } from '@testing-library/react';
import { useAuth } from '@/hooks/useAuth';

describe('useAuth 훅', () => {
  it('초기 상태가 올바르다', () => {
    const { result } = renderHook(() => useAuth());
    
    expect(result.current.user).toBeNull();
    expect(result.current.loading).toBe(false);
  });

  it('로그인이 작동한다', async () => {
    const { result } = renderHook(() => useAuth());
    
    await act(async () => {
      await result.current.login('test@example.com', 'password');
    });
    
    expect(result.current.user).not.toBeNull();
  });
});
```

### API 테스트
```typescript
// __tests__/services/api.test.ts
import { api } from '@/services/api';
import axios from 'axios';

jest.mock('axios');
const mockedAxios = axios as jest.Mocked<typeof axios>;

describe('API 서비스', () => {
  it('약관 목록을 가져온다', async () => {
    const mockData = { items: [], total: 0 };
    mockedAxios.get.mockResolvedValue({ data: mockData });
    
    const result = await api.getPolicies();
    
    expect(result).toEqual(mockData);
    expect(mockedAxios.get).toHaveBeenCalledWith('/policies');
  });
});
```

### E2E 테스트 (선택적 - Playwright)
```typescript
// e2e/login.spec.ts
import { test, expect } from '@playwright/test';

test('사용자 로그인 플로우', async ({ page }) => {
  await page.goto('http://localhost:3000');
  
  await page.fill('input[type="email"]', 'test@example.com');
  await page.fill('input[type="password"]', 'password123');
  await page.click('button[type="submit"]');
  
  await expect(page).toHaveURL('http://localhost:3000/dashboard');
  await expect(page.locator('h1')).toContainText('대시보드');
});
```

## 테스트 원칙

### AAA 패턴
- **Arrange**: 테스트 준비 (데이터, Mock 설정)
- **Act**: 테스트 대상 실행
- **Assert**: 결과 검증

```python
@pytest.mark.asyncio
async def test_example():
    # Arrange
    user = {"email": "test@example.com", "password": "password"}
    
    # Act
    result = await login(user)
    
    # Assert
    assert result.status_code == 200
```

### 테스트 독립성
- 각 테스트는 독립적으로 실행 가능해야 함
- 테스트 간 의존성 금지
- 각 테스트 후 상태 초기화

### 의미 있는 테스트명
```python
# 나쁜 예
def test_1():
    pass

# 좋은 예
def test_login_with_valid_credentials_returns_token():
    pass
```

### 테스트 커버리지 목표
- **핵심 비즈니스 로직**: 90% 이상
- **API 엔드포인트**: 80% 이상
- **유틸리티 함수**: 70% 이상
- **UI 컴포넌트**: 60% 이상

## 통합 테스트

### 전체 파이프라인 테스트
```python
# test_integrated_pipeline.py
@pytest.mark.asyncio
async def test_full_rag_pipeline():
    """PDF 업로드부터 검색까지 전체 파이프라인 테스트"""
    
    # 1. PDF 업로드
    with open("test.pdf", "rb") as f:
        response = await client.post("/policies/upload", files={"file": f})
    assert response.status_code == 200
    policy_id = response.json()["id"]
    
    # 2. 처리 완료 대기
    await asyncio.sleep(5)
    
    # 3. 검색 테스트
    response = await client.post(
        "/search",
        json={"query": "보험료 납입 기간은?"}
    )
    assert response.status_code == 200
    assert len(response.json()["results"]) > 0
```

## CI/CD 통합

### GitHub Actions 예시
```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.11
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov
      - name: Run tests
        run: |
          cd backend
          pytest --cov=. --cov-report=xml
      - name: Upload coverage
        uses: codecov/codecov-action@v2

  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 18
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      - name: Run tests
        run: |
          cd frontend
          npm test -- --coverage
```
